<html>
<head>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
  <script src="/static/jquery.sparkline.min.js"></script>
  <script type="text/javascript">
    function GetData() {
      // TODO: If the form is partially filled out, don't do anything.

      jQuery.get("/data", ParseAndShowData, "json")
            .fail(ShowDataFailure)
    }

    function ParseAndShowData(data, textStatus, jqXHR) {
      // Show num_seasons speed sparkline
      ShowVelocity(data['Num_seasons'])

      // Show top players
      ShowTopPlayers(data['Top_players'], data['Teams'])

      // Show teams and keepers
      ShowTeams(data['Teams'])

      setTimeout(GetData, 3000)
    }

    var recent_velocity = [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
    var last_num_seasons = 0
    function ShowVelocity(num_seasons) {
      var velocity = num_seasons - last_num_seasons
      last_num_seasons = num_seasons
      recent_velocity.push(velocity)
      recent_velocity.shift()
      $('#velocity').html(velocity)
      $('#velocity-sparkline').sparkline(recent_velocity);
    }

    function ShowTopPlayers(top_players, teams) {
      $('#players tr').remove()
      for (var i = 0; i < top_players.length; i++) {
        var player = top_players[i]
        var newrow = $('<tr></tr>')
        newrow.append($('<td></td>').append(i+1) )
        newrow.append($('<td></td>').append(
            player['Firstname'] + ' ' + player['Lastname']))
        if (player['Total_wins'] > 0) {
          var wins_per_season = player['Total_wins'] / player['Num_seasons']
          newrow.append($('<td></td>').append(wins_per_season.toFixed(2)))
        } else {
          newrow.append($('<td>-</td>'))
        }

        // TODO: Finish form for drafting keepers
        for (var t = 0; t < teams.length; t++) {
          var radio = $('<input type="radio"/>').attr('name', player['ID'])
                                                .val(t)
          newrow.append($('<td></td>').append(radio))
        }

        newrow.appendTo('#players')
      }
    }

    function ShowTeams(teams) {
      $('#teams *').remove()

      for (var i = 0; i < teams.length; i++) {
        var team = teams[i]

        var teamheader = $('<h2></h2>').html(team['Name'])
        teamheader.appendTo('#teams')

        // Show the keepers on the roster
        var roster = $('<ul></ul>')
        for (var pos in team['Roster']) {
          for (var j = 0; j < team['Roster'][pos].length; j++) {
            var player = team['Roster'][pos][j]['Player']
            if (player['Keeper']) {
              roster.append($('<li></li>').html(
                  player['Firstname'] + ' ' + player['Lastname']))
            }
          }
        }
        if (roster.html() == "") {
          roster.append($('<li><i>No roster yet</i></li>'))
        }
        roster.appendTo('#teams')
      }
    }

    function ShowDataFailure(jqXHR, textStatus, errorThrown) {
      // TODO: Show failure message

      // TODO: Back off
      setTimeout(GetData, 3000)
    }

    $(document).ready(function() {
      GetData();
    })
  </script>

  <style type="text/css">
    body {
      margin: 0;
    }
    h1 {
      margin: 0;
      padding: 10px;
      background: yellow;
    }

    #sidebar {
      width: 350px;
      float: left;
      padding: 10px;
      background: #ddd;
    }

    #players {
      margin: 10px 0 0 380px;
      border: solid 2px black;
      border-collapse: collapse;
    }
    #players td {
      border: solid 1px #666;
      padding: 2px 4px;
    }

    #teams {
      font-size: 80%;
    }
    #teams h2 {
      font-size: 120%;
      margin-bottom: 2px;
    }
    #teams ul {
      margin: 0 0 0 10px;
      padding-left: 10px;
    }
  </style>

  <title>fbtron</title>
</head>
<body>
<h1>fbtron</h1>

<div id="sidebar">
  Velocity: <span id="velocity-sparkline"></span>
    <b><span id="velocity"></span> seasons/sec</b>

  <div id="teams">
  </div>
</div>

<table id="players">
</table>

</body>
</html>
